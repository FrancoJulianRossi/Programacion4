const { spawn } = require("child_process");
const fs = require("fs");
const path = require("path");
const { db } = require("../config/database");

// ✅ SEGURO: Command Injection - Medidas de seguridad implementadas
const ping = (req, res) => {
  const { host } = req.body;

  // Lista de hosts permitidos
  const allowedHosts = ["8.8.8.8", "1.1.1.1", "google.com", "localhost"];

  const ipRegex = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/;
  const hostnameRegex = /^[a-zA-Z0-9.-]+$/;

  // Validar que el input sea válido
  if (!host || (!ipRegex.test(host) && !hostnameRegex.test(host))) {
    return res.status(400).json({ error: "Invalid host" });
  }

  if (!allowedHosts.includes(host)) {
    return res.status(400).json({ error: "Invalid host" });
  }

  try {
    // Nunca concatenar strings para formar comandos
    const pingProcess = spawn("ping", ["-c", "4", host], {
      timeout: 30000, // Timeout de 30 segundos para evitar procesos colgados
    });

    let output = "";
    let errorOutput = "";

    pingProcess.stdout.on("data", (data) => {
      output += data.toString();
    });

    pingProcess.stderr.on("data", (data) => {
      errorOutput += data.toString();
    });

    pingProcess.on("close", (code) => {
      if (code === 0) {
        res.json({ output });
      } else {
        //No exponer detalles del sistema
        res.status(500).json({
          error: "Host is unreachable or invalid",
        });
      }
    });

    pingProcess.on("error", (err) => {
      //No exponer errores internos
      res.status(500).json({
        error: "Error executing ping command",
      });
    });
  } catch (error) {
    res.status(500).json({
      error: "Error executing ping command",
    });
  }
};

// VULNERABLE: CSRF - Transferencia sin token CSRF
const transfer = (req, res) => {
  const { fromAccount, toAccount, amount } = req.body;

  // VULNERABLE: No verifica token CSRF
  if (!req.session.userId) {
    return res.status(401).json({ error: "No autenticado" });
  }

  const query =
    "INSERT INTO transfers (from_account, to_account, amount, user_id) VALUES (?, ?, ?, ?)";
  db.query(
    query,
    [fromAccount, toAccount, amount, req.session.userId],
    (err) => {
      if (err) {
        return res.status(500).json({ error: "Error en la transferencia" });
      }
      res.json({ message: "Transferencia realizada con éxito" });
    }
  );
};

// VULNERABLE: Local File Inclusion
const readFile = (req, res) => {
  const { filename } = req.query;

  // VULNERABLE: Path traversal
  const filePath = path.join(__dirname, "../files", filename);

  fs.readFile(filePath, "utf8", (err, data) => {
    if (err) {
      return res.status(404).json({ error: "Archivo no encontrado" });
    }
    res.send(data);
  });
};

module.exports = {
  ping,
  transfer,
  readFile,
};
